<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard COVID-19</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --hover-color: #1557b0;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #5f6368;
            --border-color: #dde1e7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            padding-top: 60px;
            color: var(--text-primary);
        }

        /* Navbar Styles */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            padding: 15px 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            color: white;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 3rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-card .number {
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: bold;
        }

        /* Chart Section */
        .visualization-section {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Options Panel */
        .options-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .option-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .option-group label {
            display: block;
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        /* Interactive Elements */
        select,
        input:not([type="color"]) {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover,
        input:not([type="color"]):hover {
            border-color: var(--primary-color);
        }

        select:focus,
        input:not([type="color"]):focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        /* Color Picker Styling */
        .color-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .color-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .color-option:hover {
            background-color: #f0f0f0;
        }

        .color-option input[type="color"] {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
        }

        .color-option input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-option input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        /* Dataset Toggles */
        .dataset-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .toggle-item:hover {
            background-color: #f0f0f0;
        }

        .toggle-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Chart Container */
        .chart-container {
            height: 500px;
            position: relative;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Additional Chart Controls */
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .control-btn:hover {
            background: var(--hover-color);
        }

        /* Tooltip Styles */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>COVID-19 Dashboard</h1>
            <div class="nav-links">
                <a href="#mondial" class="nav-link active" onclick="switchView('mondial')"
                    data-tooltip="Statistiques mondiales">Vue Mondiale</a>
                <a href="#regions" class="nav-link" onclick="switchView('regions')"
                    data-tooltip="Analyse par région">Par Région</a>
                <a href="#pays" class="nav-link" onclick="switchView('pays')" data-tooltip="Données par pays">Par
                    Pays</a>
                <a href="#correlation" class="nav-link" onclick="switchView('correlation')"
                    data-tooltip="Analyse des corrélations">Corrélations</a>
                <a href="#tendances" class="nav-link" onclick="switchView('tendances')"
                    data-tooltip="Analyse des tendances">Tendances</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" onclick="toggleDataset('confirmed')"
                data-tooltip="Cliquez pour afficher/masquer dans le graphique">
                <h3>Cas Confirmés</h3>
                <div class="number" id="confirmed">...</div>
            </div>
            <div class="stat-card" onclick="toggleDataset('deaths')"
                data-tooltip="Cliquez pour afficher/masquer dans le graphique">
                <h3>Décès</h3>
                <div class="number" id="deaths">...</div>
            </div>
            <div class="stat-card" onclick="toggleDataset('recovered')"
                data-tooltip="Cliquez pour afficher/masquer dans le graphique">
                <h3>Guéris</h3>
                <div class="number" id="recovered">...</div>
            </div>
            <div class="stat-card" onclick="toggleDataset('active')"
                data-tooltip="Cliquez pour afficher/masquer dans le graphique">
                <h3>Cas Actifs</h3>
                <div class="number" id="active">...</div>
            </div>
        </div>

        <!-- Vue Mondiale Section -->
        <div id="mondial" class="visualization-section">
            <div class="options-panel">
                <div class="options-grid">
                    <div class="option-group">
                        <label>Type de visualisation</label>
                        <select id="chartType" onchange="updateChart()" data-tooltip="Choisissez le type de graphique">
                            <option value="line">Ligne</option>
                            <option value="bar">Barres</option>
                            <option value="area">Aire</option>
                        </select>
                    </div>

                    <div class="option-group">
                        <label>Format des données</label>
                        <select id="dataFormat" onchange="updateChart()"
                            data-tooltip="Choisissez le format d'affichage des données">
                            <option value="raw">Valeurs brutes</option>
                            <option value="daily">Variation quotidienne</option>
                        </select>
                    </div>

                    <div class="option-group">
                        <label>Échelle Y</label>
                        <select id="scaleType" onchange="updateChart()" data-tooltip="Choisissez l'échelle de l'axe Y">
                            <option value="linear">Linéaire</option>
                            <option value="logarithmic">Logarithmique</option>
                        </select>
                    </div>
                </div>

                <div class="options-grid" style="margin-top: 20px;">
                    <div class="option-group">
                        <label>Datasets visibles</label>
                        <div class="dataset-toggles">
                            <label class="toggle-item">
                                <input type="checkbox" checked id="toggleConfirmed"
                                    onchange="toggleDataset('confirmed')">
                                <span>Cas confirmés</span>
                            </label>
                            <label class="toggle-item">
                                <input type="checkbox" checked id="toggleDeaths" onchange="toggleDataset('deaths')">
                                <span>Décès</span>
                            </label>
                            <label class="toggle-item">
                                <input type="checkbox" checked id="toggleRecovered"
                                    onchange="toggleDataset('recovered')">
                                <span>Guéris</span>
                            </label>
                            <label class="toggle-item">
                                <input type="checkbox" checked id="toggleActive" onchange="toggleDataset('active')">
                                <span>Cas actifs</span>
                            </label>
                        </div>
                    </div>

                    <div class="option-group">
                        <label>Personnalisation des couleurs</label>
                        <div class="color-options">
                            <div class="color-option">
                                <input type="color" id="confirmedColor" value="#1a73e8" onchange="updateChart()">
                                <span>Confirmés</span>
                            </div>
                            <div class="color-option">
                                <input type="color" id="deathsColor" value="#dc3545" onchange="updateChart()">
                                <span>Décès</span>
                            </div>
                            <div class="color-option">
                                <input type="color" id="recoveredColor" value="#28a745" onchange="updateChart()">
                                <span>Guéris</span>
                            </div>
                            <div class="color-option">
                                <input type="color" id="activeColor" value="#ffc107" onchange="updateChart()">
                                <span>Actifs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-controls">
                <button class="control-btn" onclick="resetZoom()" data-tooltip="Réinitialiser le zoom">Reset</button>
                <button class="control-btn" onclick="downloadChart()"
                    data-tooltip="Télécharger le graphique">Télécharger</button>
                <button class="control-btn" onclick="exportData()" data-tooltip="Exporter les données en CSV">Exporter
                    CSV</button>
            </div>

            <div class="chart-container">
                <canvas id="worldChart"></canvas>
            </div>
        </div>


        <!-- Section Par Région -->
        <div id="regions" class="visualization-section" style="display: none;">
            <div class="options-panel">
                <div class="options-grid">
                    <div class="option-group">
                        <label>Type de visualisation</label>
                        <select id="regionChartType" onchange="updateRegionChart()">
                            <option value="line">Ligne</option>
                            <option value="bar">Barres</option>
                            <option value="area">Aire</option>
                        </select>
                    </div>

                    <div class="option-group">
                        <label>Format des données</label>
                        <select id="regionDataFormat" onchange="updateRegionChart()">
                            <option value="raw">Valeurs brutes</option>
                            <option value="daily">Variation quotidienne</option>
                        </select>
                    </div>

                    <div class="option-group">
                        <label>Échelle Y</label>
                        <select id="regionScaleType" onchange="updateRegionChart()">
                            <option value="linear">Linéaire</option>
                            <option value="logarithmic">Logarithmique</option>
                        </select>
                    </div>
                </div>

                <div class="options-grid" style="margin-top: 20px;">
                    <div class="option-group">
                        <label>Régions visibles</label>
                        <div class="dataset-toggles" id="regionToggles">
                            <!-- Cette partie sera remplie dynamiquement -->
                        </div>
                    </div>

                    <div class="option-group">
                        <label>Personnalisation des couleurs</label>
                        <div class="color-options" id="regionColors">
                            <!-- Cette partie sera remplie dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-controls">
                <button class="control-btn" onclick="downloadRegionChart()">Télécharger</button>
                <button class="control-btn" onclick="exportRegionData()">Exporter CSV</button>
            </div>

            <div class="chart-container">
                <canvas id="regionChart"></canvas>
            </div>
        </div>
    </div>


    <script>

        // Variables pour la section régionale
        let regionChart = null;
        let regionData = null;
        let regionConfig = {
            datasets: {},
            colors: {}
        };

        // Les couleurs par défaut pour les régions
        const defaultRegionColors = {
            'Europe': '#1a73e8',
            'Americas': '#dc3545',
            'Western Pacific': '#28a745',
            'Eastern Mediterranean': '#ffc107',
            'Africa': '#6f42c1',
            'South-East Asia': '#fd7e14'
        };

        // Variables globales
        let worldChart = null;
        let chartData = null;
        let chartConfig = {
            datasets: {
                confirmed: true,
                deaths: true,
                recovered: true,
                active: true
            },
            colors: {
                confirmed: '#1a73e8',
                deaths: '#dc3545',
                recovered: '#28a745',
                active: '#ffc107'
            }
        };

        // Fonction pour formater les nombres
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return new Intl.NumberFormat().format(num);
        }

        // Fonction pour obtenir les options du graphique
        function getChartOptions() {
            const scaleType = document.getElementById('scaleType').value;

            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            color: '#666'
                        },
                        onClick: function (e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            const meta = ci.getDatasetMeta(index);

                            meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                            ci.update();

                            // Mise à jour des checkboxes
                            const datasetId = ci.data.datasets[index].id;
                            document.getElementById(`toggle${datasetId}`).checked = !meta.hidden;
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255,255,255,0.9)',
                        titleColor: '#666',
                        bodyColor: '#666',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${formatNumber(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: scaleType,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#666',
                            callback: function (value) {
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
                                return value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#666',
                            maxRotation: 45,
                            minRotation: 45,
                            maxTicksLimit: 12
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            };
        }

        // Chargement des statistiques globales
        async function loadGlobalStats() {
            try {
                const response = await fetch('http://localhost:3000/api/global-stats');
                const data = await response.json();

                document.getElementById('confirmed').textContent = formatNumber(data.total_confirmed);
                document.getElementById('deaths').textContent = formatNumber(data.total_deaths);
                document.getElementById('recovered').textContent = formatNumber(data.total_recovered);
                document.getElementById('active').textContent = formatNumber(data.total_active);
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors du chargement des statistiques globales');
            }
        }

        // Mise à jour du graphique
        async function updateChart() {
            try {
                toggleLoading(true);
                const response = await fetch('http://localhost:3000/api/global-timeline');
                let data = await response.json();

                // Stocker les données pour l'export CSV
                chartData = data;

                const chartType = document.getElementById('chartType').value;
                const dataFormat = document.getElementById('dataFormat').value;

                // Traitement des données selon le format
                data = processData(data, dataFormat);

                const ctx = document.getElementById('worldChart').getContext('2d');

                if (worldChart) {
                    worldChart.destroy();
                }

                const datasets = [];

                // Création des datasets en fonction des sélections
                if (chartConfig.datasets.confirmed) {
                    datasets.push(createDataset('Confirmed', data.map(item => item.confirmed), chartConfig.colors.confirmed));
                }
                if (chartConfig.datasets.deaths) {
                    datasets.push(createDataset('Deaths', data.map(item => item.deaths), chartConfig.colors.deaths));
                }
                if (chartConfig.datasets.recovered) {
                    datasets.push(createDataset('Recovered', data.map(item => item.recovered), chartConfig.colors.recovered));
                }
                if (chartConfig.datasets.active) {
                    datasets.push(createDataset('Active', data.map(item => item.active), chartConfig.colors.active));
                }

                worldChart = new Chart(ctx, {
                    type: getChartType(chartType),
                    data: {
                        labels: data.map(item => new Date(item.date).toLocaleDateString()),
                        datasets: datasets
                    },
                    options: getChartOptions()
                });
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors de la mise à jour du graphique');
            } finally {
                toggleLoading(false);
            }
        }

        // Fonction helper pour créer un dataset
        function createDataset(label, data, color) {
            const chartType = document.getElementById('chartType').value;
            return {
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: chartType === 'bar' ? `${color}88` : `${color}22`,
                fill: chartType === 'area',
                tension: 0.4,
                id: label.toLowerCase(),
                pointRadius: chartType === 'scatter' ? 4 : 0,
                pointHoverRadius: 6
            };
        }

        // Toggle dataset visibility
        function toggleDataset(datasetName) {
            chartConfig.datasets[datasetName] = !chartConfig.datasets[datasetName];
            updateChart();
        }

        // Reset zoom
        function resetZoom() {
            if (worldChart) {
                worldChart.resetZoom();
            }
        }

        // Download chart as image
        function downloadChart() {
            if (worldChart) {
                const link = document.createElement('a');
                link.download = 'covid-chart.png';
                link.href = worldChart.toBase64Image();
                link.click();
            }
        }



        // Export data as CSV
        function exportData() {
            if (!chartData) return;

            const rows = [['Date', 'Confirmed', 'Deaths', 'Recovered', 'Active']];
            chartData.forEach(item => {
                rows.push([
                    new Date(item.date).toLocaleDateString(),
                    item.confirmed,
                    item.deaths,
                    item.recovered,
                    item.active
                ]);
            });

            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "covid_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Fonction pour changer de vue
        function switchView(view) {
            // Cacher toutes les sections
            document.querySelectorAll('.visualization-section').forEach(section => {
                section.style.display = 'none';
            });

            // Afficher la section sélectionnée
            document.getElementById(view).style.display = 'block';

            // Mettre à jour les onglets de navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[href="#${view}"]`).classList.add('active');

            // Charger les données appropriées
            switch (view) {
                case 'mondial':
                    loadGlobalStats();
                    updateChart();
                    break;
                case 'regions':
                    updateRegionChart();
                    break;
                case 'pays':
                    // À implémenter plus tard
                    break;
                case 'correlation':
                    // À implémenter plus tard
                    break;
                case 'tendances':
                    // À implémenter plus tard
                    break;
            }
        }

        // Fonction pour traiter les données selon le format choisi
        function processData(data, format) {
            switch (format) {
                case 'percentage':
                    const totals = data.map(item => item.confirmed + item.deaths + item.recovered + item.active);
                    return data.map((item, i) => ({
                        ...item,
                        confirmed: (item.confirmed / totals[i]) * 100,
                        deaths: (item.deaths / totals[i]) * 100,
                        recovered: (item.recovered / totals[i]) * 100,
                        active: (item.active / totals[i]) * 100
                    }));
                case 'daily':
                    return data.map((item, index) => {
                        if (index === 0) return item;
                        return {
                            ...item,
                            confirmed: item.confirmed - data[index - 1].confirmed,
                            deaths: item.deaths - data[index - 1].deaths,
                            recovered: item.recovered - data[index - 1].recovered,
                            active: item.active - data[index - 1].active
                        };
                    });
                case 'weekly':
                    return calculateMovingAverage(data, 7);
                case 'monthly':
                    return calculateMovingAverage(data, 30);
                default:
                    return data;
            }
        }

        // Fonction pour calculer la moyenne mobile
        function calculateMovingAverage(data, window) {
            return data.map((item, index, array) => {
                if (index < window - 1) return item;

                const slice = array.slice(index - window + 1, index + 1);
                return {
                    ...item,
                    confirmed: slice.reduce((sum, curr) => sum + curr.confirmed, 0) / window,
                    deaths: slice.reduce((sum, curr) => sum + curr.deaths, 0) / window,
                    recovered: slice.reduce((sum, curr) => sum + curr.recovered, 0) / window,
                    active: slice.reduce((sum, curr) => sum + curr.active, 0) / window
                };
            });
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.cssText = `
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Fonction pour obtenir le type de graphique
        function getChartType(selectedType) {
            switch (selectedType) {
                case 'area':
                    return 'line';
                case 'mixed':
                    return 'bar';
                default:
                    return selectedType;
            }
        }

        // Fonction pour mettre à jour le graphique régional
        async function updateRegionChart() {
            try {
                console.log('Début updateRegionChart');
                toggleLoading(true);

                const response = await fetch('http://localhost:3000/api/region-stats');
                console.log('Réponse reçue:', response);

                let data = await response.json();
                console.log('Données reçues:', data);

                // Stocker les données pour l'export CSV
                regionData = data;

                const chartType = document.getElementById('regionChartType').value;
                const dataFormat = document.getElementById('regionDataFormat').value;
                const scaleType = document.getElementById('regionScaleType').value;

                // Obtenir la liste unique des régions
                const regions = [...new Set(data.map(item => item.region_name))];
                console.log('Régions uniques:', regions);

                // Traitement des données selon le format
                data = processRegionData(data, dataFormat);

                // Initialiser regionConfig pour les nouvelles régions
                regions.forEach(region => {
                    if (regionConfig.datasets[region] === undefined) {
                        regionConfig.datasets[region] = true;
                        regionConfig.colors[region] = defaultRegionColors[region];
                    }
                });

                // Regrouper les données par région
                const groupedData = {};
                regions.forEach(region => {
                    groupedData[region] = data.filter(item => item.region_name === region)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                const ctx = document.getElementById('regionChart').getContext('2d');

                if (regionChart) {
                    regionChart.destroy();
                }

                // Créer les datasets
                const datasets = regions
                    .filter(region => regionConfig.datasets[region])
                    .map(region => ({
                        label: region,
                        data: groupedData[region].map(item => item.confirmed),
                        borderColor: regionConfig.colors[region] || defaultRegionColors[region],
                        backgroundColor: chartType === 'bar' ?
                            `${regionConfig.colors[region] || defaultRegionColors[region]}88` :
                            `${regionConfig.colors[region] || defaultRegionColors[region]}22`,
                        fill: chartType === 'area',
                        tension: 0.4
                    }));

                // Créer le graphique
                regionChart = new Chart(ctx, {
                    type: getChartType(chartType),
                    data: {
                        labels: groupedData[regions[0]].map(item => new Date(item.date).toLocaleDateString()),
                        datasets: datasets
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            y: {
                                type: scaleType,
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });

                // Mise à jour des toggles et des couleurs
                updateRegionToggles(regions);
                updateRegionColors();

            } catch (error) {
                console.error('Erreur détaillée:', error);
                showError('Erreur lors de la mise à jour du graphique régional');
            } finally {
                toggleLoading(false);
            }
        }

        // Fonction pour traiter les données régionales
        function processRegionData(data, format) {
            switch (format) {
                case 'daily':
                    return data.map((item, index, arr) => {
                        if (index === 0) return item;
                        const prevItem = arr.find(prev =>
                            prev.region_name === item.region_name &&
                            new Date(prev.date) < new Date(item.date)
                        );
                        return {
                            ...item,
                            confirmed: prevItem ? item.confirmed - prevItem.confirmed : item.confirmed,
                            deaths: prevItem ? item.deaths - prevItem.deaths : item.deaths,
                            recovered: prevItem ? item.recovered - prevItem.recovered : item.recovered
                        };
                    });
                default:
                    return data;
            }
        }

        // Fonction pour mettre à jour les toggles des régions
        function updateRegionToggles(regions) {
            const container = document.getElementById('regionToggles');
            if (!container) return;

            const togglesHTML = regions.map(region => `
        <label class="toggle-item">
            <input type="checkbox" checked 
                   id="toggle${region.replace(/\s+/g, '')}" 
                   onchange="toggleRegion('${region}')">
            <span>${region}</span>
        </label>
    `).join('');

            container.innerHTML = togglesHTML;

            // Initialiser regionConfig
            regions.forEach(region => {
                if (regionConfig.datasets[region] === undefined) {
                    regionConfig.datasets[region] = true;
                }
            });
        }

        // Fonction pour mettre à jour les sélecteurs de couleur
        function updateRegionColors() {
            const container = document.getElementById('regionColors');
            container.innerHTML = Object.keys(regionConfig.datasets).map(region => `
        <div class="color-option">
            <input type="color" 
                   id="color${region.replace(/\s+/g, '')}"
                   value="${regionConfig.colors[region] || defaultRegionColors[region]}"
                   onchange="updateRegionColor('${region}', this.value)">
            <span>${region}</span>
        </div>
    `).join('');
        }

        // Fonction pour basculer la visibilité d'une région
        function toggleRegion(region) {
            regionConfig.datasets[region] = !regionConfig.datasets[region];
            updateRegionChart();
        }

        // Fonction pour mettre à jour la couleur d'une région
        function updateRegionColor(region, color) {
            regionConfig.colors[region] = color;
            updateRegionChart();
        }

        // Fonction pour télécharger le graphique régional
        function downloadRegionChart() {
            if (regionChart) {
                const link = document.createElement('a');
                link.download = 'region-chart.png';
                link.href = regionChart.toBase64Image();
                link.click();
            }
        }

        // Fonction pour exporter les données régionales
        function exportRegionData() {
            if (!regionData) return;

            const rows = [['Date', 'Region', 'Confirmed', 'Deaths', 'Recovered', 'Active']];
            regionData.forEach(item => {
                rows.push([
                    new Date(item.date).toLocaleDateString(),
                    item.region_name,
                    item.confirmed,
                    item.deaths,
                    item.recovered,
                    item.active
                ]);
            });

            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "region_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Fonction pour changer de vue
        function switchView(view) {
            try {
                // Masquer toutes les stats cards si on n'est pas dans la vue mondiale
                const statsGrid = document.querySelector('.stats-grid');
                if (statsGrid) {
                    statsGrid.style.display = view === 'mondial' ? 'grid' : 'none';
                }

                // Cacher toutes les sections
                document.querySelectorAll('.visualization-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Afficher la section sélectionnée
                const selectedSection = document.getElementById(view);
                if (selectedSection) {
                    selectedSection.style.display = 'block';
                }

                // Mettre à jour la navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const activeLink = document.querySelector(`[href="#${view}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }

                // Charger les données appropriées
                switch (view) {
                    case 'mondial':
                        loadGlobalStats();
                        updateChart();
                        break;
                    case 'regions':
                        // S'assurer que les éléments nécessaires existent avant de charger
                        if (document.getElementById('regionChart')) {
                            updateRegionChart();
                        }
                        break;
                    case 'pays':
                        // À implémenter plus tard
                        break;
                    case 'correlation':
                        // À implémenter plus tard
                        break;
                    case 'tendances':
                        // À implémenter plus tard
                        break;
                }
            } catch (error) {
                console.error('Erreur lors du changement de vue:', error);
                showError('Erreur lors du changement de vue');
            }
        }

        // Fonction pour afficher/masquer le message de chargement
        function toggleLoading(show) {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                if (show) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading';
                    loadingDiv.textContent = 'Chargement des données...';
                    container.appendChild(loadingDiv);
                } else {
                    const loading = container.querySelector('.loading');
                    if (loading) loading.remove();
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalStats();
            updateChart();

            // Event listeners pour les changements de couleur
            ['confirmed', 'deaths', 'recovered', 'active'].forEach(dataset => {
                document.getElementById(`${dataset}Color`).addEventListener('change', (e) => {
                    chartConfig.colors[dataset] = e.target.value;
                    updateChart();
                });
            });
        });
    </script>
</body>

</html>